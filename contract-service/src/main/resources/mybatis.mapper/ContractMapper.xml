<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bizondam.contract_service.mapper.ContractMapper">

    <resultMap id="ContractPdfResultMap" type="ContractDto">
        <id property="requestId" column="request_id"/>
        <result property="responseId" column="response_id"/>
        <result property="contractId" column="contract_Id"/>
        <result property="buyerCompanyName" column="buyer_company_name"/>
        <result property="buyerCompanyAddress" column="buyer_company_address"/>
        <result property="buyerCompanyAddressDetail" column="buyer_company_address_detail"/>
        <result property="supplierCompanyName" column="supplier_company_name"/>
        <result property="buyerUserName" column="buyer_user_name"/>
        <result property="buyerUserPhone" column="buyer_user_phone"/>
        <result property="supplierUserName" column="supplier_user_name"/>
        <result property="supplierUserPhone" column="supplier_user_phone"/>
        <result property="dueDate" column="due_date"/>
        <result property="totalPrice" column="total_price"/>
        <result property="paymentTerms" column="payment_terms"/>
        <result property="warranty" column="warranty"/>
        <result property="contractCreatedAt" column="contract_created_at"/>
    </resultMap>

    <resultMap id="ContractItemResultMap" type="ContractItemDto">
        <id property="itemId" column="item_id"/>
        <result property="specification" column="specification"/>
        <result property="quantity" column="quantity"/>
        <result property="categoryName" column="category_name"/>
        <result property="detailCategoryName" column="detail_category_name"/>
        <result property="unitPrice" column="unit_price"/>
        <result property="deliveryDays" column="delivery_days"/>
    </resultMap>


    <!--계약서 메타 + 회사 + 유저 정보 조회-->
    <select id="findContractPdfData" resultMap="ContractPdfResultMap" parameterType="map">
        SELECT
            er.request_id,
            resp.response_id,
            cb.company_name_kr           AS buyer_company_name,
            cb.address                   AS buyer_company_address,
            cb.address_detail            AS buyer_company_address_detail,
            cs.company_name_kr           AS supplier_company_name,
            bu.name_kr                   AS buyer_user_name,
            bu.phone_number              AS buyer_user_phone,
            su.name_kr                   AS supplier_user_name,
            su.phone_number              AS supplier_user_phone,
            er.due_date,
            resp.total_price,
            resp.payment_terms,
            resp.warranty,
            c.contract_Id,
            c.created_at                 AS contract_created_at
        FROM contracts c
                 JOIN estimate_response resp ON c.response_id = resp.response_id
                 JOIN estimate_request er     ON resp.request_id = er.request_id
                 JOIN companies cb            ON er.buyer_company_id = cb.company_id
                 JOIN companies cs            ON er.supplier_company_id = cs.company_id
                 JOIN users bu                ON c.buyer_user_id = bu.user_id
                 JOIN users su                ON c.supplier_user_id = su.user_id
        WHERE er.request_id = #{requestId}
          AND resp.response_id = #{responseId}
    </select>

    <!--계약 품목 리스트 조회-->
    <select id="findContractPdfItems" resultMap="ContractItemResultMap" parameterType="map">
        SELECT
            item.item_id,
            item.specification,
            item.quantity,
            meta.category_name,
            meta.detail_category_name,
            resp_item.unit_price,
            resp_item.delivery_days
        FROM estimate_request_item item
                 LEFT JOIN estimate_response_item resp_item
                           ON item.item_id = resp_item.item_id AND resp_item.response_id = #{responseId}
                 LEFT JOIN product_meta_batch meta
                           ON item.product_id = meta.product_id
        WHERE item.request_id = #{requestId}
    </select>

    <!--계약서 url 업데이트-->
    <update id="updateContractFileUrl">
        UPDATE contracts
        SET contract_file_url = #{url}
        WHERE contract_id = #{contractId}
    </update>

</mapper>